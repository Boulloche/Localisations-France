<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Jeu de Localisation - France</title>
<style>
body { margin:0; font-family:Arial,sans-serif; }
#container { display:flex; height:90vh; }
#map-container {
  flex:3; position:relative; border:1px solid #333;
  background:url("https://www.cartesfrance.fr/cartes/fond_carte_france.jpg") no-repeat center/contain;
  background-size:contain;
}
#admin-panel, #game-panel {
  flex:1; margin-left:10px; display:flex; flex-direction:column;
  border:1px solid #333; overflow-y:auto;
}
#login-panel {
  flex:1; margin-left:10px; display:flex; flex-direction:column;
  border:1px solid #333; overflow-y:auto; text-align:center;
  padding:20px;
}
table { width:100%; border-collapse:collapse; flex:1; }
th, td { border:1px solid #333; padding:5px; text-align:left; }
tr.selected { background:yellow; }
tr.placeholder { background:#ddd; border:dashed 1px #333; }
.zone {
  position:absolute; background:rgba(0,128,255,0.3); cursor:pointer;
  border-radius:50%;
}
.zone.selected { outline:2px solid blue; }
.zone.game-zone { background:rgba(0,200,100,0.3); }
.handle {
  position:absolute; width:8px; height:8px; background:red;
  border-radius:50%; cursor:move; z-index:10;
}
button { margin:2px; padding:5px 10px; cursor:pointer; }
svg { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
polygon { fill:rgba(0,128,255,0.3); stroke:blue; stroke-width:2; }
polygon.game-polygon { fill:rgba(0,200,100,0.3); }
input, select { width:90%; padding:5px; }
#add-modal, #login-modal {
  display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  background:white; padding:20px; border:1px solid #333; border-radius:5px;
  box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:100;
}
#mode-buttons { margin-bottom:10px; text-align:center; }
#score-display { font-weight:bold; margin:10px 0; text-align:center; font-size:1.2em; }
#game-question { font-size:1.2em; margin:10px 0; text-align:center; }
#game-feedback { margin:10px 0; text-align:center; color:red; font-weight:bold; }
.game-correct { color:green !important; }
.game-button { padding:8px 15px; font-size:1em; margin:0 5px; }
#login-form { display:flex; flex-direction:column; align-items:center; }
#login-form input { margin:10px; width:80%; padding:8px; }
#login-error { color:red; margin:10px 0; }
#welcome-message { margin:20px 0; }
.game-instructions { margin:20px 0; font-style:italic; }
#timer { text-align:center; font-size:1.2em; font-weight:bold; margin:5px 0; }
</style>
</head>
<body>
<h2>Jeu de Localisation <span id="mode-indicator">(Mode Jeu)</span></h2>
<div id="mode-buttons">
  <button id="mode-admin" class="game-button">Mode Admin</button>
  <button id="mode-game" class="game-button">Mode Jeu</button>
</div>
<div id="container">
  <div id="map-container"></div>
  <div id="login-panel">
    <div id="welcome-message">
      <h3>Bienvenue au jeu de localisation !</h3>
      <p>Cliquez sur "Mode Jeu" pour commencer à jouer.</p>
      <p class="game-instructions">Trouvez les villes, provinces, fleuves et montagnes sur la carte de France.</p>
    </div>
  </div>
  <div id="admin-panel" style="display:none;">
    <div>
      <button id="add-row">Ajouter</button>
      <button id="delete-row">Supprimer</button>
      <button id="edit-row">Modifier</button>
    </div>
    <table id="locations">
      <thead><tr><th>Nom</th><th>Type</th><th>Coordonnées</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="game-panel">
    <div id="score-display">Score: 0/0</div>
    <div id="timer">Temps: 0s</div>
    <div id="game-question">Cliquez sur "Mode Jeu" pour commencer</div>
    <div id="game-feedback"></div>
  </div>
</div>
<div id="add-modal">
  <h3>Ajouter une zone</h3>
  <label>Nom: <input type="text" id="new-name" required></label><br>
  <label>Type: <select id="new-type">
    <option value="point">Point</option>
    <option value="polygone">Polygone</option>
  </select></label><br>
  <button id="confirm-add">Confirmer</button>
  <button id="cancel-add">Annuler</button>
</div>
<div id="login-modal">
  <h3>Accès Admin</h3>
  <form id="login-form">
    <input type="password" id="password-input" placeholder="Mot de passe" required>
    <div id="login-error"></div>
    <button type="submit" id="submit-password" class="game-button">Se connecter</button>
  </form>
</div>
<script>
// ===== CONFIGURATION =====
const ADMIN_PASSWORD = "vymzywnz";
let loginAttempts = 0;
const MAX_ATTEMPTS = 3;
const LOCKOUT_TIME = 5*60*1000;

// ===== VARIABLES =====
const map = document.getElementById("map-container");
const tbody = document.querySelector("#locations tbody");
const adminPanel = document.getElementById("admin-panel");
const gamePanel = document.getElementById("game-panel");
const loginPanel = document.getElementById("login-panel");
const modeIndicator = document.getElementById("mode-indicator");
const scoreDisplay = document.getElementById("score-display");
const gameQuestion = document.getElementById("game-question");
const gameFeedback = document.getElementById("game-feedback");
const loginError = document.getElementById("login-error");
const timerDisplay = document.getElementById("timer");

let selectedRow=null, currentZone=null, currentPoints=[], handles=[], actionHistory=[], isDragging=false, isGameMode=true, gameZones=[], currentGameZone=null, score={correct:0,total:0}, lockoutUntil=0, timer=null, timeElapsed=0, timerStarted=false;

// ===== UTILITAIRES =====
const showModal=id=>document.getElementById(id).style.display="block";
const hideModal=id=>document.getElementById(id).style.display="none";
const confirmAction=msg=>confirm(msg);
function checkLockout(){if(Date.now()<lockoutUntil){const m=Math.ceil((lockoutUntil-Date.now())/60000);loginError.textContent=`Trop de tentatives. Veuillez réessayer dans ${m} minute(s).`;return true;} return false;}

// ===== MODE =====
function setAdminMode(){if(adminPanel.style.display!="none")return;if(checkLockout()){showModal("login-modal");return;} showModal("login-modal");document.getElementById("password-input").value="";loginError.textContent="";}
function setGameMode(){isGameMode=true;adminPanel.style.display="none";gamePanel.style.display="flex";loginPanel.style.display="none";modeIndicator.textContent="(Mode Jeu)";prepareGame();updateScoreDisplay();}

// ===== CHRONO =====
function startTimer(){if(timerStarted)return;timerStarted=true;timeElapsed=0;timerDisplay.textContent=`Temps: 0s`;timer=setInterval(()=>{timeElapsed++;timerDisplay.textContent=`Temps: ${timeElapsed}s`;},1000);}

// ===== ADMIN LOGIN =====
document.getElementById("mode-admin").addEventListener("click",setAdminMode);
document.getElementById("login-form").addEventListener("submit",e=>{
e.preventDefault();if(checkLockout())return;
const password=document.getElementById("password-input").value;
if(password===ADMIN_PASSWORD){hideModal("login-modal");isGameMode=false;adminPanel.style.display="flex";gamePanel.style.display="none";loginPanel.style.display="none";modeIndicator.textContent="(Mode Admin)";clearGameZones();loginAttempts=0;lockoutUntil=0;} else {loginAttempts++;loginError.textContent="Mot de passe incorrect !";if(loginAttempts>=MAX_ATTEMPTS){lockoutUntil=Date.now()+LOCKOUT_TIME;loginError.textContent=`Trop de tentatives. Veuillez réessayer dans 5 minutes.`;setTimeout(()=>{loginAttempts=0;lockoutUntil=0;if(document.getElementById("login-modal").style.display==="block"){loginError.textContent="";}},LOCKOUT_TIME);}}});

// ===== CREER LIGNE =====
function createRow(name,type,coords){const tr=document.createElement("tr");tr.dataset.name=name;tr.dataset.type=type;tr.dataset.zoneId="";const nameInput=document.createElement("input");nameInput.value=name;nameInput.readOnly=true;nameInput.style.border="none";tr.cells?tr.cells[0].appendChild(nameInput):"";const typeSelect=document.createElement("select");["point","polygone"].forEach(t=>{const opt=document.createElement("option");opt.value=t;opt.textContent=t.charAt(0).toUpperCase()+t.slice(1);if(t===type)opt.selected=true;typeSelect.appendChild(opt);});typeSelect.addEventListener("change",()=>tr.dataset.type=typeSelect.value);tr.innerHTML=`<td></td><td></td><td></td>`;tr.cells[0].appendChild(nameInput);tr.cells[1].appendChild(typeSelect);tbody.appendChild(tr);return tr;}

// ===== SELECTION =====
function selectRow(row){if(isDragging||isGameMode)return;if(selectedRow){selectedRow.classList.remove("selected");document.getElementById(selectedRow.dataset.zoneId)?.classList.remove("selected");}selectedRow=row;row.classList.add("selected");currentPoints=[];currentZone=null;handles.forEach(h=>h.remove());handles=[];const zoneId=row.dataset.zoneId;if(zoneId){currentZone=document.getElementById(zoneId);currentZone?.classList.add("selected");if(row.dataset.type==="polygone"){currentPoints=JSON.parse(row.cells[2].textContent||"[]");drawHandles();}}}

// ===== DESSIN POIGNEES =====
function drawHandles(){handles.forEach(h=>h.remove());handles=[];if(!currentZone)return;const poly=currentZone.querySelector("polygon");currentPoints.forEach((p,i)=>{const handle=document.createElement("div");handle.className="handle";handle.style.left=`${p.x-4}px`;handle.style.top=`${p.y-4}px`;map.appendChild(handle);makeDraggable(handle,(nx,ny)=>{currentPoints[i]={x:nx+4,y:ny+4};poly.setAttribute("points",currentPoints.map(p=>`${p.x},${p.y}`).join(" "));selectedRow.cells[2].textContent=JSON.stringify(currentPoints);});handles.push(handle);});}

// ===== JEU =====
function prepareGame(){gameZones=[];document.querySelectorAll("#locations tbody tr").forEach(row=>{if(row.dataset.zoneId){gameZones.push({name:row.dataset.name,type:row.dataset.type,zoneId:row.dataset.zoneId,element:document.getElementById(row.dataset.zoneId)})}});if(gameZones.length===0){gameQuestion.textContent="Aucune zone disponible. Passez en mode admin pour en ajouter.";return;} gameZones=shuffleArray(gameZones);score={correct:0,total:0};nextGameQuestion();}
function shuffleArray(a){for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function nextGameQuestion(){if(gameZones.length===0){gameQuestion.textContent=`Jeu terminé ! Votre score: ${score.correct}/${score.total}`;gameFeedback.textContent="";return;} currentGameZone=gameZones.pop();gameQuestion.textContent=`Placez ${currentGameZone.name} sur la carte !`;gameFeedback.textContent="";gameFeedback.className="";if(currentGameZone.type==="point"){currentGameZone.element.classList.add("game-zone");} else {currentGameZone.element.querySelector("polygon").classList.add("game-polygon");}}
function checkGameAnswer(x,y){if(!currentGameZone)return;const zoneElement=currentGameZone.element;const rect=zoneElement.getBoundingClientRect();const zoneX=rect.left+window.scrollX;const zoneY=rect.top+window.scrollY;let isCorrect=false;if(currentGameZone.type==="point"){const centerX=zoneX+zoneElement.offsetWidth/2;const centerY=zoneY+zoneElement.offsetHeight/2;const dist=Math.sqrt(Math.pow(x-centerX,2)+Math.pow(y-centerY,2));isCorrect=dist<=20;} else {const poly=zoneElement.querySelector("polygon");const points=poly.getAttribute("points").split(" ").map(p=>p.split(",")).map(([x,y])=>({x:parseFloat(x)+zoneX,y:parseFloat(y)+zoneY}));isCorrect=pointInPolygon({x,y},points);}if(isCorrect){gameFeedback.textContent="Bonne réponse !";gameFeedback.className="game-correct";score.correct++;} else {gameFeedback.textContent="Mauvaise réponse, essayez encore !";} score.total++;updateScoreDisplay();if(isCorrect){setTimeout(()=>{if(currentGameZone.type==="point"){currentGameZone.element.classList.remove("game-zone");} else {currentGameZone.element.querySelector("polygon").classList.remove("game-polygon");} nextGameQuestion();},1000);}}
function pointInPolygon(point,polygon){let inside=false;for(let i=0,j=polygon.length-1;i<polygon.length;j=i++){const xi=polygon[i].x,yi=polygon[i].y;xj=polygon[j].x,yj=polygon[j].y;const intersect=((yi>point.y)!==(yj>point.y))&&(point.x<(xj-xi)*(point.y-yi)/(yj-yi)+xi);if(intersect)inside=!inside;}return inside;}
function updateScoreDisplay(){scoreDisplay.textContent=`Score: ${score.correct}/${score.total}`;}

// ===== EVENEMENTS =====
document.getElementById("mode-game").addEventListener("click",()=>{setGameMode();startTimer();});
map.addEventListener("click",e=>{if(isGameMode){startTimer();checkGameAnswer(e.clientX,e.clientY);}});

// ===== PRÉ-REMPLISSAGE =====
["Paris","Marseille","Lyon","Toulouse","Nice","Nantes","Montpellier","Strasbourg","Bordeaux","Lille","Rennes","Reims","Le Havre","Saint-Étienne","Toulon","Grenoble","Dijon","Angers","Nîmes","Villeurbanne","Bretagne","Auvergne","Île-de-France","Nouvelle-Aquitaine","Occitanie","Provence-Alpes-Côte d'Azur","Hauts-de-France","Normandie","Grand Est","Bourgogne-Franche-Comté","Ouessant","Seine","Loire","Rhône","Garonne","Alpes","Pyrénées","Massif-Central","Vosges","Corsica"].forEach(name=>createRow(name,"point",""));
</script>
</body>
</html>
